<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI 에이전트</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; max-width: 900px; margin: 40px auto; line-height: 1.6; background-color: #f4f7f6; }
        
        #chat-box { 
            background: white; 
            border-radius: 12px; 
            padding: 25px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            
            /* 고정된 높이 설정 (원하는 높이로 조정 가능) */
            height: 500px; 
            
            /* 내용이 많아지면 스크롤바 생성 */
            overflow-y: auto; 
            
            margin-bottom: 20px;
            
            /* 부드러운 스크롤 적용 */
            scroll-behavior: smooth;
        }

        /* 로딩 스피너 애니메이션 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-container {
            display: flex;
            align-items: center;
            color: #555;
            font-style: italic;
            padding: 10px;
        }

        /* 마크다운 스타일링 */
        #chat-box h1, #chat-box h2, #chat-box h3 { color: #2c3e50; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        #chat-box ul, #chat-box ol { padding-left: 25px; }
        #chat-box code { background: #f0f0f0; padding: 2px 5px; border-radius: 4px; font-family: monospace; }
        #chat-box blockquote { border-left: 4px solid #3498db; padding-left: 15px; color: #555; margin-left: 0; }
        
        .input-area { display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none; }
        input:focus { border-color: #3498db; box-shadow: 0 0 5px rgba(52,152,219,0.3); }
        button { padding: 12px 24px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background 0.3s; }
        button:hover { background: #2980b9; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <h2>질의응답 Agent</h2>
    <div id="chat-box"></div>
    
    <div class="input-area">
        <input type="text" id="user-input" placeholder="질문을 입력하세요..." onkeypress="if(event.keyCode==13) askAI()">
        <button id="submit-btn" onclick="askAI()">질문하기</button>
    </div>

    <script>
        async function askAI() {
            const inputElement = document.getElementById('user-input');
            const submitBtn = document.getElementById('submit-btn');
            const chatBox = document.getElementById('chat-box');
            const question = inputElement.value;
            
            if(!question.trim()) return;

            // 1. 입력창 비우고 버튼 비활성화 (중복 클릭 방지)
            inputElement.value = ""; 
            submitBtn.disabled = true;

            // 2. 대기 상태 표시 (스피너 애니메이션)
            chatBox.innerHTML = `
                <div class="loading-container">
                    <div class="loader"></div>
                    <span>답변을 생성 중입니다...</span>
                </div>
            `;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question })
                });

                if (!response.ok) throw new Error("서버 응답 오류");

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = "";

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataContent = line.replace('data: ', '').trim();
                            if (dataContent === '[DONE]') break;

                            try {
                                const parsed = JSON.parse(dataContent);
                                if (parsed.answer) {
                                    fullText = parsed.answer;
                                    // 답변이 오기 시작하면 스피너를 지우고 마크다운 렌더링
                                    chatBox.innerHTML = marked.parse(fullText);
                                }
                            } catch (e) { console.error("JSON 파싱 에러", e); }
                        }
                    }
                }
            } catch (error) {
                chatBox.innerHTML = `<span style="color:red;">오류 발생: ${error.message}</span>`;
            } finally {
                // 3. 버튼 다시 활성화
                submitBtn.disabled = false;
            }
        }
    </script>
</body>
</html>